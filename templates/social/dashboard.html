{% extends 'base.html' %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Welcome, {{ user.username }}!</h1>

    <div class="row g-5">
        <!-- LEFT COLUMN: Your Posts & Messages You've Received -->
        <div class="col-md-7">
            
            <!-- MESSAGES RECEIVED -->
            <h2 data-aos="fade-right">Messages Received</h2>
            {% for message in received_messages %}
            <div class="card mb-3" data-aos="fade-up">
                <div class="card-header">
                    From: <strong>{{ message.sender.username }}</strong> | Regarding: "{{ message.post.title }}"
                </div>
                <div class="card-body">
                    <p class="card-text">"{{ message.body }}"</p>
                    {% if message.sender_phone %}
                        <p class="card-text"><strong>Their Contact:</strong> {{ message.sender_phone }}</p>
                    {% endif %}
                </div>
                <div class="card-footer text-end">
                    {% if message.is_approved %}
                        <span class="badge bg-success"><i class="fas fa-check"></i> Approved</span>
                    {% else %}
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#approveModal-{{ message.id }}">
                            Approve & Share Contact
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Approval Modal (one for each message) -->
            <div class="modal fade" id="approveModal-{{ message.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Approve Offer from {{ message.sender.username }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form method="POST" action="{% url 'approve_message' message.id %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <p>By approving, you can optionally share your phone number directly with this person.</p>
                        <div class="mb-3">
                            <label for="recipient-phone-{{ message.id }}" class="form-label">Your Phone Number (Optional)</label>
                            <input type="text" name="recipient_phone" class="form-control" id="recipient-phone-{{ message.id }}" placeholder="Share your number for easy contact">
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Confirm Approval</button>
                      </div>
                  </form>
                </div>
              </div>
            </div>
            {% empty %}
            <p>You have not received any messages yet.</p>
            {% endfor %}

            <hr class="my-5">

            <!-- MY POSTS -->
            <h2 data-aos="fade-right">My Requirements</h2>
            {% for post in user_posts %}
            <div class="card mb-3" data-aos="fade-up">
                <!-- ... your existing post display code ... -->
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title">{{ post.title }}</h5>
                        <span class="badge {% if post.is_active %}bg-success{% else %}bg-danger{% endif %}">
                            {% if post.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    <p class="card-text">{{ post.description|truncatewords:20 }}</p>
                    <p class="card-text"><small class="text-muted">Posted on {{ post.created_at|date:"d M Y" }}</small></p>
                    <a href="{% url 'edit_post' post.id %}" class="btn btn-primary btn-sm">Edit</a>
                    <a href="{% url 'delete_post' post.id %}" class="btn btn-outline-danger btn-sm ms-2">Delete</a>
                </div>
            </div>
            {% empty %}
            <p>You have not posted any requirements yet.</p>
            {% endfor %}
        </div>

        <!-- RIGHT COLUMN: Messages You've Sent -->
        <div class="col-md-5">
            <h2 data-aos="fade-left">Messages Sent</h2>
            {% for message in sent_messages %}
            <div class="alert alert-secondary" role="alert" data-aos="fade-up">
                <h6 class="alert-heading">To: <strong>{{ message.recipient.username }}</strong> | For: "{{ message.post.title }}"</h6>
                <p>"{{ message.body }}"</p>
                <hr>
                <div class="d-flex justify-content-between">
                    <p class="mb-0 small">Sent: {{ message.sent_at|date:"d M Y" }}</p>
                    {% if message.is_approved %}
                        <strong class="text-success"><i class="fas fa-check-circle"></i> Approved</strong>
                    {% else %}
                        <span class="text-muted">Pending Approval</span>
                    {% endif %}
                </div>
                {% if message.is_approved and message.recipient_phone_on_approval %}
                    <div class="mt-2 p-2 bg-light border rounded">
                        <strong>Their Contact:</strong> {{ message.recipient_phone_on_approval }}
                    </div>
                {% endif %}
            </div>
            {% empty %}
            <p>You have not sent any messages yet.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}